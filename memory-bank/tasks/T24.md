# T24: Migrate from better-sqlite3 to sql.js

*Created: 2025-12-16 16:36:00 IST*
*Last Updated: 2025-12-16 17:00:00 IST*

**Description**: Replace `better-sqlite3` (native addon) with `sql.js` (pure WASM) across the entire codebase to enable predictable installation without Node/V8 ABI friction and enable future single-executable bundling. This migration affects both the standalone server package and all CLI template parser/query scripts.

**Status**: ðŸ”„ In Progress
**Priority**: HIGH
**Started**: 2025-12-16
**Last Active**: 2025-12-16 17:00:00 IST
**Dependencies**: T19, T21, T13

## Context

Previous work completed:
- âœ… Setup Wizard as default entry point (no-CLI initialization)
- âœ… Standalone npm server package structure
- âœ… Full viewer/editor functionality

**Current blocker**: `better-sqlite3` is a native Node addon that causes installation friction (compilation required, platform-specific binaries, V8 ABI compatibility issues). This prevents reliable cross-platform installation and blocks single-executable distribution.

**Solution**: Migrate to `sql.js` (WASM SQLite) which is pure JavaScript, has no native dependencies, and works identically across all platforms.

## Completion Criteria

### Phase 1: Server Package Migration
- [ ] Create `memory-bank/database/lib/sqlite.js` adapter module
- [ ] Update `memory-bank/database/package.json` (remove better-sqlite3, add sql.js)
- [ ] Migrate `memory-bank/database/server.js` to use sql.js adapter
- [ ] Test setup wizard, viewer, editor, and import workflows

### Phase 2: CLI Templates Migration
- [ ] Create `mb-cli/templates/memory-bank/database/lib/sqlite.js` adapter
- [ ] Update `mb-cli/templates/memory-bank/database/package.json`
- [ ] Migrate parser scripts: parse-edits.js, parse-tasks.js, parse-sessions.js, parse-session-cache.js
- [ ] Migrate query scripts: query.js, query-tasks.js
- [ ] Update `mb-cli/src/commands/init.js` to include new lib/sqlite.js file
- [ ] Test all parser and query scripts

### Phase 3: Validation
- [ ] Clean install test on fresh project
- [ ] Verify zero native compilation
- [ ] Validate all endpoints work
- [ ] Confirm database persistence across restarts

## Related Files

### Server Package
- `memory-bank/database/lib/sqlite.js` (NEW)
- `memory-bank/database/server.js`
- `memory-bank/database/package.json`

### CLI Templates
- `mb-cli/templates/memory-bank/database/lib/sqlite.js` (NEW)
- `mb-cli/templates/memory-bank/database/package.json`
- `mb-cli/templates/memory-bank/database/server.js`
- `mb-cli/templates/memory-bank/database/parse-edits.js`
- `mb-cli/templates/memory-bank/database/parse-tasks.js`
- `mb-cli/templates/memory-bank/database/parse-sessions.js`
- `mb-cli/templates/memory-bank/database/parse-session-cache.js`
- `mb-cli/templates/memory-bank/database/query.js`
- `mb-cli/templates/memory-bank/database/query-tasks.js`

### CLI Infrastructure
- `mb-cli/src/commands/init.js`

### Documentation
- `memory-bank/implementation-details/sqljs-migration-keeping-parsers.md`

## Technical Approach

### sql.js Adapter Pattern
Create a thin adapter (`lib/sqlite.js`) that provides:
- `openDb(dbPath)` - Load existing DB from disk or create new in-memory DB
- `queryAll(sql, params)` - Execute query, return all rows
- `queryGet(sql, params)` - Execute query, return first row
- `execRun(sql, params)` - Execute write statement
- `saveDb()` - Export in-memory DB to disk (with write queue to prevent corruption)
- `withTransaction(fn)` - Best-effort transaction support

### Key Behavioral Changes
1. **Async initialization**: sql.js WASM loading is async
2. **Explicit persistence**: Must call `saveDb()` after writes (sql.js is in-memory)
3. **Write serialization**: Queue saves to prevent concurrent corruption

## Scope Estimate
- **Files modified**: ~12-15
- **Files created**: 2 (lib/sqlite.js in server + templates)
- **Lines changed**: ~1200-2500
- **Testing**: Server endpoints + all parser/query scripts

## Success Metrics
- âœ… `npm install` succeeds without compilation
- âœ… Works on all platforms (Windows, macOS, Linux)
- âœ… All existing functionality preserved
- âœ… Database persists correctly across restarts
- âœ… No performance regressions for typical use cases
