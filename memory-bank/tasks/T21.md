# T21: Database-Native Memory Bank Update Workflow

*Created: 2025-11-13 17:48:20 IST*
*Last Updated: 2025-12-17 10:41:19 IST*

**Description**: Design and implement database-native approach to memory bank updates where database is authoritative source and text files are generated output. Replaces manual text editing with atomic database transactions.

**Status**: ðŸ”„ In Progress (Phase A Complete, File Viewer Added, DB Selection/Import Integrated)

**Priority**: HIGH

**Started**: 2025-11-13

**Last Active**: 2025-12-17 10:41:19 IST

**Dependencies**: T20, T20a, T13

## Completion Criteria

- âœ… Design Phase: Database-native Section 6.5 workflow documented
- âœ… Schema Expansion: Add sessions, session_cache, error_logs tables
- âœ… Phase A Testing: Complete test suite with synthetic data validation
- âœ… File Viewer: Integrated file browser and viewer for markdown files
- âœ… Browser Update Workflow: Import markdown -> DB for all core memory bank files (incl. task file subtasks)
- â¬œ Insert Functions: Implement database write operations
- â¬œ Regeneration Functions: Implement text file generation (DB -> markdown)
- â¬œ CLI Commands: Build mb workflow commands
- â¬œ Integration Testing: End-to-end workflow validation

## Progress

### Phase 1: Design (Completed 2025-11-13 17:48:20 IST)
- âœ… Analyzed current text-based Section 6.5 workflow
- âœ… Designed database-first alternative approach
- âœ… Created expanded schema (8 tables with foreign keys)
- âœ… Documented 4-phase database workflow (Pre-update, DB ops, Text regeneration, Validation)
- âœ… Created `database-update-workflow-plan.md` (comprehensive guide)

### Phase A: Schema Expansion (Completed 2025-11-13 18:31:12 IST)
- âœ… Created isolated workspace at `t21-workflow-testing/` for testing
- âœ… Implemented 8-table schema: edit_entries, file_modifications, task_items, task_dependencies, sessions, session_cache, error_logs, transaction_log
- âœ… Created schema.sql with complete table definitions and 21 indexes
- âœ… Implemented dual initialization scripts: init-schema.js (better-sqlite3) and init-schema-sqljs.js (sql.js)
- âœ… Added Node v20 specification (.nvmrc)
- âœ… Created package.json with both dependencies and scripts
- âœ… Created SETUP.md with quick start documentation
- âœ… Set up pnpm workspace configuration

### Phase A Testing & Validation (Completed 2025-11-13 22:36:44 IST)
- âœ… Implemented synthetic test data generator (generate-test-data.js, 380 lines) generating 7 realistic data sets
- âœ… Created comprehensive Phase A test suite (test-schema.js, 540 lines) with 4 test suites
  - Suite 1: Schema structure validation (8 tables, column presence)
  - Suite 2: Constraints and indexes (foreign keys, 15+ indexes)
  - Suite 3: Data insertion (tasks, entries, files, sessions, errors - all passing)
  - Suite 4: Query performance (all queries sub-100ms)
- âœ… Built Express.js API server (server.js, 270 lines) with 6 endpoints for database exploration
- âœ… Created single-page HTML UI (explorer.html, 480 lines) for visual database browsing
- âœ… Updated package.json: added express ^4.18.2, better-sqlite3 ^12.0.0, updated scripts
- âœ… Generated test database (test_memory_bank.db) with validated test data
- âœ… Schema validation complete: all constraints enforced, indexes created, queries performant

### Phase A Explorer Enhancements (Completed 2025-11-13 22:50:00 IST)
- âœ… Enhanced explorer.html with dark/light mode theming (~450 lines added)
- âœ… Implemented dual view modes (Cards & Tables) for all tables
- âœ… Added per-table filtering and column sorting with state persistence
- âœ… Updated server.js with enhanced relationship metadata and primary key detection
- âœ… Extended test-schema.js with task_dependencies and session_cache test suites
- âœ… Fixed schema.sql: removed foreign key constraints on task_dependencies for cross-dataset refs
- âœ… Explorer now fully functional with complete data visibility and navigation

### Parser Script Integration (Completed 2025-11-27 16:55:30 IST)
- âœ… Copied all 4 parser scripts to T21 folder: parse-edits.js, parse-tasks.js, parse-sessions.js, parse-session-cache.js
- âœ… Copied query scripts: query.js, query-tasks.js
- âœ… T21 database folder now contains complete parser suite for consistency
- âœ… CLI can now copy parsers from T21 source ensuring all projects have latest versions

### Server Enhancements (Completed 2025-11-27 16:55:30 IST)
- âœ… Changed default database path from test_memory_bank.db to memory_bank.db
- âœ… Added --help flag with comprehensive usage documentation
- âœ… Added --port flag for custom port configuration
- âœ… Enhanced CLI help shows all options: --db, --port, --help
- âœ… Server now matches parser output expectations (memory_bank.db)

### File Viewer Implementation (Completed 2025-11-28 10:28:37 IST)
- âœ… Added /api/memory-bank/files endpoint (Backend)
  - Returns 5 file categories: Core, Tasks, Sessions, Implementation, Database
  - Includes file metadata: name, path, size, modification timestamp
  - Organizes files by category with smart sorting
- âœ… Added /api/memory-bank/file/* endpoint (Backend)
  - Fetches specific file content with security path traversal checks
  - Returns file content and metadata as JSON
- âœ… Implemented tab-based navigation (Frontend)
  - "Database" tab for SQLite record browsing
  - "Files" tab for markdown file browsing
  - Tab switching updates sidebar and search placeholder dynamically
- âœ… Built file browser UI (Frontend)
  - Category sidebar with file count metadata
  - File list with size and modification date
  - File viewer with markdown rendering (marked.js) and code syntax support
- âœ… Extended router and state management
  - New state types: 'tab', 'fileCategory', 'file'
  - Browser history API integration for back/forward navigation
  - Automatic mode switching when restoring history states
- âœ… Enhanced CSS styling
  - Tab navigation buttons with active states
  - Category and file item hover/active styling
  - Markdown content rendering (headers, lists, code, blockquotes, tables)
  - Full dark/light mode support throughout

### Edit History DB-first + Editor Utilities (Updated 2025-12-16 13:22:00 IST)
- âœ… Added DB selection + creation support in the canonical viewer server
  - GET /api/db/current, GET /api/db/list, POST /api/db/open, POST /api/db/create
- âœ… Added edit_history import workflow for DB-first ingestion
  - GET /api/import/edit-history/preview
  - POST /api/import/edit-history/run (append/replace)
- âœ… Added request logging and explicit server-side error logs for operational visibility
- âœ… Restricted all filesystem access to memory-bank/ (DB paths and source files)

### Browser Database Update Workflow (Planned)
- âœ… Added browser imports for: tasks.md, sessions/*.md, session_cache.md
- â¬œ Add regeneration/export: DB -> markdown files with backups and roundtrip validation

## Related Files

- `implementation-details/database-update-workflow-plan.md` - Complete workflow design (4 phases, expanded schema)
- `memory-bank/database/` - Canonical viewer + parsers location (server, schema, scripts, public assets)
- `mb-cli/src/lib/` - Modular CLI architecture (validators, parsers, prompts, writers)
- `tasks/T20.md` - Database parser (Phase 3)
- `tasks/T20a.md` - Adaptive LLM format parser (Design phase)
- `tasks/T13.md` - CLI implementation (90% complete, modular refactor started)

## Context

T21 implements a paradigm shift: database becomes authoritative source instead of text files. Text files transition from manually-edited source to auto-generated output from database state. This enables:

1. **Atomicity**: Single database transaction for all updates
2. **Consistency**: Database enforces constraints
3. **Automation**: Deterministic text regeneration
4. **Simplicity**: 4 workflow steps vs 8 manual steps

### Key Design Decisions

1. **Expanded Schema**: 8 tables (edit_entries, file_modifications, tasks, task_dependencies, sessions, session_cache, error_logs, transaction_log)
2. **Atomic Transactions**: All Phase 1 operations in single transaction
3. **Deterministic Regeneration**: Text output always matches database state
4. **Backward Compatibility**: Existing data preserved during schema expansion
5. **Phased Migration**: Coexistence period before database-first transition

### Architecture

```
Text Files (currently authoritative)
  â†“ (parse with T20)
Database (currently derived)
  â†“ (new workflow)
Updates recorded in database transaction
  â†“ (regenerate Phase 3)
Text Files (generated from database)
```

## Implementation Phases

### Phase A: Schema Expansion (Planned - Part of T20)
- Add sessions, session_cache, error_logs tables
- Add transaction_log table
- Create indexes for performance
- Validate with existing data

### Phase B: Insert Functions (Planned - Part of T20)
- insertEditEntry()
- insertFileModification()
- updateTaskStatus()
- createSession()
- updateSessionCache()
- insertErrorLog()

### Phase C: Text Regeneration (Planned - Part of T20)
- regenerateEditHistory()
- regenerateTasks()
- regenerateSessionCache()
- regenerateActiveContext()
- regenerateErrorLog()
- regenerateChangelog()

### Phase D: CLI Commands (Planned - Part of T13)
- mb workflow update-session
- mb workflow log-work
- mb workflow complete-task
- mb workflow sync

### Phase E: Testing (Planned - Part of T20)
- End-to-end workflow testing
- Data integrity verification
- Text file validation
- Performance testing

## Next Steps

1. Review workflow plan design
2. Implement Phase A: Schema expansion
3. Implement Phase B: Database functions
4. Implement Phase C: Text regeneration
5. Implement Phase D: CLI integration
6. Execute Phase E: Testing

## Benefits of Database-Native Approach

| Aspect | Text-Based | Database-Based |
|--------|-----------|-----------------|
| Workflow Steps | 8 | 4 |
| Manual Files | 6 | 0 |
| Error Risk | High | Low |
| Update Time | ~5 min | ~30 sec |
| Consistency | Manual | Automatic |
| Atomicity | None | Full |

## Risks & Mitigations

- **Data Loss**: Regular backups, schema validation
- **Sync Issues**: Regenerate on every commit
- **Migration Complexity**: Phased approach, coexistence period
- **User Confusion**: Clear CLI help, documentation

## Session Notes

Designed database-native workflow replacing manual Section 6.5 process. System timestamp automatically captured from local system (IST timezone). Comprehensive implementation plan created covering schema, functions, and CLI integration across T20, T13, and testing phases.
